---
title: "Clase 1 - Asignando propiedades estéticas a los datos"
author: "Diplomatura en Ciencias Sociales Computacionales y Humanidades"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r, include=FALSE}
library(tidyverse)
library(ggplot2)

menstru <- readRDS('./data/menstru_data.RDS')

resumen_menstru <- menstru %>% group_by(fecha) %>%
              summarise(median_precio = median(precio_unidad))

regiones <- menstru %>% group_by(fecha, Region) %>%
  summarise(mediana_precios = median(precio_unidad))
```
# Introducción

Aquí practicaremos un concepto central de `ggplot`, la asignación (*mapping* en inglés) de atributos estéticos a los valores que toma una variable. Dicho de otra forma, como mostrar de modo perceptible a la vista la diferencia entre valores: generalmente lo hacemos describiendo posiciones de un valor x y un valor y, pero también puedo definir un tamaño, una forma, o un color.

![](./img/aes.png){width="80%"}

Usaremos el paquete de R [**ggplot2**](https://ggplot2.tidyverse.org/), que incluye funciones para realizar una gran variedad de visualizaciones.

```{r , echo = TRUE, eval = FALSE}
# cargar la librería que vamos a usar
library(ggplot2)
```

El data set con el que practicaremos está almacenado en R como `resumen_menstru`, y contiene la mediana de precios para productos de gestión menstrual (toallitas y tampones) en Argentina entre 2020 y 2022. Los datos fueron obtenidos del [MenstruScrapper](https://github.com/Ecofeminita/EcoFemiData/tree/master/MenstruAccion/cuanto_cuesta_menstruar) de EcoFemiData, el área de datos de EcoFeminita.

```{r}
resumen_menstru
```

## Uso básico de `ggplot`

Si le pasamos un dataframe a `ggplot()`, sin agregar nada más, obtenemos un gráfico vacío:

```{r}
ggplot(resumen_menstru)
```

¡Vendría a ser una especie de lienzo en blanco!

Esto es porque necesitamos definir al menos una geometría (el recurso visual con el que vamos a mostrar la información, como líneas, puntos, barras, etc.) y al menos una asignación estética (especificar cuales variables queremos mostrar, y que atributo estético va a representar sus valores, como el color, el tamaño, la transparencia, etc.).

`ggplot()` implementa un marco teórico para la creación de visualizaciones, ["la gramática de los gráficos"](https://www.slideshare.net/0xdata/leland-wilkinson-h2oai-the-grammar-of-graphics-and-the-future-of-big-data-visualization-h2o-world-2019-nyc). Ésta permite expresar en forma concisa los componentes de un gráfico:

![](./img/ggplot_resumen.png){width="70%"}

¿Cómo funciona ésto en la práctica? El caso de uso más simple de ggplot consiste en:

-   una llamada a la función `ggplot()`, pasándole un **dataset** y una "asignación de atributos estéticos" (*aesthetic mapping* en inglés) usando `aes()`
-   al menos una capa "geom", que define el recurso gráfico que mostrará los datos; por ejemplo `geom_line()` para dibujar líneas o `geom_point()` para dibujar puntos.

A intentarlo. Asignemos la columna `fecha` a la posición en el eje de las $x$, la columna `median_precio` a las $y$, y usemos `geom_line()` para mostrar los datos.

```{r}
ggplot(resumen_menstru, aes(x = fecha, y = median_precio)) +
  geom_line()
```

Ahora otra vez, pero usando `geom_point()` en vez de `geom_line()`.

```{r}
ggplot(resumen_menstru, aes(x = fecha, y = median_precio)) +
  geom_point()
```

Y ahora intercambiemos las columnas que antes asignamos a las $x$ y a las $y$:

```{r}
ggplot(resumen_menstru, aes(x = median_precio, y = fecha)) +
  geom_point()
```

## Otras *geoms* más complejas

Pueden elegir entre una variada colección de geoms para hacer toda clase de gráficos. Por ejemplo, `geom_boxplot()` crea *boxplots* (o ["diagramas de caja"](https://economipedia.com/definiciones/diagrama-de-caja.html)). Al hacer boxplots es común mostrar un gráfico separado para cada categoría presente en la data a mostrar, usando para eso el eje de las $x$ o de las $y$. ¡Hagamos eso mismo!

En esta ocasión, vamos a trabajar con el dataframe completo de los precios de toallitas y tampones. Démosle un vistazo:

```{r}
head(menstru)
```

Como pueden ver, tiene muchas más variables que el primer dataset que tarbajamos. Contiene el tipo de producto, la marca, el comercio donde se vende a ese precio, la provincia, el precio de lista, la región... y muchas otras variables más. En nuestro boxplot, vamos a explorar cómo evoluciona el precio por unidad de los productos a lo largo de las fechas disponibles. 

Pongamos `fecha` en el eje $x$, `temperature` en el eje de las $y$, y a dibujar cajas con `geom_boxplot()`.

```{r}
ggplot(menstru, aes(x = fecha, y = precio_unidad)) +
  geom_boxplot()
```

¡Ups! No se ve como esperábamos. Un pequeño detalle es que ggplot toma las variables de fecha, correctamente, como variables continuas. Esto nos es útil a veces, como vimos más arriba en los gráficos de líneas y de dispersión. Pero en este caso, querríamos ver cada período de tiempo como una "cajita", es decir, como una variable categórica. Por ello vamos a pasarle al eje $x$ la fecha transformada en una variable categórica con `as.character()`.

```{r}
ggplot(menstru, aes(x = as.character(fecha), y = precio_unidad)) +
  geom_boxplot()
```

¿Qué pasa si lo damos vuelta?

```{r}
ggplot(menstru, aes(x = precio_unidad, y = as.character(fecha))) +
  geom_boxplot()
```

Ahora bien, ¿qué quiere decirnos este gráfico? Si bien los vamos a volver a ver en profundidad un par de clases más adelante, a priori podemos decir que es un gráfico que nos permite ver de manera rápida la distribución de los valores de una variable. La caja nos muestra entre qué valores se encuentra el rango intercuartílico de la variable, y la línea que corta la caja nos muestra cuál es la mediana. Las dos líneas nos muestran cuáles son los valores mínimo y máximo "corregidos", es decir, aquellos que están 1,5 desvíos intercuartílicos por abajo o por arriba del primer y tercer cuartil. Los puntitos que restan son los outliers. 

![](./img/boxplot.png){width="70%"}


## Agregando color

Ahora pasamos a trabajar con el dataset `regiones`, que es similar a `resumen_menstru` pero contiene registros desagregados para todas las regiones del país:

Hagamos un gráfico de líneas mostrando `mediana_precios` para cada `fecha`, usando el atributo estético *color* para diferencias las líneas según la ciudad que representan.

```{r}
ggplot(regiones, aes(x = fecha, y = mediana_precios, color = Region)) +
  geom_line()
```

Vamos de nuevo, esta vez usando `Region` como variable en el eje $y$, y `mediana_precios` a representar con color. Este gráfico queda mejor usando`geom_point()`.

```{r}
ggplot(regiones, aes(x = fecha, y = Region, color = mediana_precios)) +
  geom_point()
```

## Usando el atributo estético `fill`

Algunas geoms permiten usar el atributo estético `fill`, que es similar `color` pero se aplica como relleno, "pintando" por dentro áreas como las barras de un gráfico o las regiones en un mapa (`color`, en cambio, se usa para líneas y puntos). Por ejemplo, podemos usar el atributo estético `fill` con `geom_boxplot()` para pintar el interior de cada caja. Vamos a probarlo. Generemos un gráfico de `month` en las $x$, `temperature` en las $y$, y coloreemos el interior de cada caja según su región.

```{r}
ggplot(regiones, aes(x = fecha, y = mediana_precios, fill = Region)) +
  geom_boxplot()
```

¿Podemos pintar las líneas de las cajas según el mes, y pintar el interior según la ubicación? Veamos.

```{r}
ggplot(regiones, aes(x = fecha, y = mediana_precios, color = fecha, fill = Region)) +
  geom_boxplot()
```

El gráfico que obtuvimos funciona como recordatorio de que en muchas ocasiones la cantidad de recursos visuales volcados resulta inversamente proporcional a su legibilidad. En general, simple es bueno... pero también conviene saber que podemos combinar varias estéticas dentro de `aes()` cuando resulte necesario.

## Atributos estéticos fijos

Muchos de los atributos estéticos -como `color`, `fill`, y también `size` que cambia el tamaño de puntos y grosor de líneas- pueden ser usados como parámetros fijos para una geom; es decir, que no cambien de acuerdo a los valores de una variable, sino que son iguales para todos las figuras graficadas. Esto se logra definiendo un valor específico, y fuera del llamado a `aes()`. Por ejemplo, `color = "blue"` en lugar de la asignación de una variable, como `aes(color = city)`. Nótese la diferencia: dentro de la función `aes()`, no definimos colores específicos, ggplot se encarga de eso. Sólo decimos que los valores encontrados en la columna `city` deben corresponder a diferentes colores. (Más adelante vamos a aprender como indicarle a ggplot que use escalas de colores específicas cuando asigna colores por variable).

Intentémoslo con el ejemplo del boxplot en la sección anterior. Asignemos el color como atributo dependiente de la ciudad, pero dejemos el color de las líneas fijo en color gris (`"gray8"`) de acuerdo a los [nombres de colores que R sabe interpretar](http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf)

```{r}
ggplot(regiones, aes(x = fecha, y = mediana_precios, fill = Region)) +
  geom_boxplot(color = 'gray8')
```

Ahora al revés. Asignemos la variable `city` al color de las líneas, pero dejemos el relleno de las cajas fijo en color `"gray8"`.

```{r}
ggplot(regiones, aes(x = fecha, y = mediana_precios, color = Region)) +
  geom_boxplot(fill = 'gray8')
```

¡Y con eso terminamos!
